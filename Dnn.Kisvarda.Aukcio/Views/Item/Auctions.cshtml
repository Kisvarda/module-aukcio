@inherits DotNetNuke.Web.Mvc.Framework.DnnWebViewPage<IEnumerable<Kisvarda.Dnn.Dnn.Kisvarda.Aukcio.Models.Item>>


@using System
@using DotNetNuke.Web.Mvc.Helpers
@using DotNetNuke.Entities.Users
@using DotNetNuke.Framework.JavaScriptLibraries

@{
    
    var userId = UserController.Instance.GetCurrentUserInfo().UserID;
}
<link rel="stylesheet" href="../../module.css" />

<div class="auction-list">

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["SuccessMessage"]
        </div>
    }

    @foreach (var item in Model)
    {
        var timeRemaining = item.AuctionEndTime.HasValue ? item.AuctionEndTime.Value - DateTime.Now : TimeSpan.Zero;


        <div class="content-wrapper">

            <div class="auction-content-left">
                <img class="auction-image" src="@item.ImageUrl" alt="@item.ItemName" />
            </div>

            <div class="auction-content-right">
                <div class="auction-card">
                    <div class="auction-details">
                        <h2 class="auction-heading">@item.ItemName</h2>

                        <p class="auction-description">@item.ItemDescription</p>

                        <div class="auction-inputs-wrapper">

                            <div class="auction-prices">
                                <p class="input-tag">Highest bid:</p>
                                <div class="max-bid">
                                    $@item.HighestBid
                                </div>
                                <p class="input-tag">Starting price: <strong>$@item.StartingPrice</strong></p>
                                <p class="input-tag">Minimum increment: <strong>$@item.MinimumBidIncrement</strong></p>

                            </div>

                            <form action="@Url.Action("Auctions", "Item", new { itemId = item.ItemId })" method="post" class="bid-form">
                                <input type="hidden" name="ItemId" value="@item.ItemId" />
                                <input type="hidden" name="UserId" value="@userId" />
                                <label class="input-tag">Bid Amount:</label>
                                <input type="number" class="auction-input" name="BidAmount" min="@item.MinimumBidIncrement" required />
                                <button class="auction-button" type="submit">Place bid</button>
                            </form>

                            <div class="time-remaining" data-time-remaining="@Math.Max(0, timeRemaining.TotalSeconds)">
                                @if (timeRemaining.TotalSeconds <= 0)
                                {
                                    <span class="ended-text" aria-label="Auction ended">Auction ended</span>
                                }
                                else
                                {
                                    <span class="clock-icon" aria-label="Time remaining">⏰</span>
                                    <span class="countdown">    @(timeRemaining.Days) days @(timeRemaining.Hours) hours @(timeRemaining.Minutes) minutes @(timeRemaining.Seconds) seconds</span>
                                }
                            </div>

                            <div class="time-remaining" data-time-remaining="@Math.Max(0, timeRemaining.TotalSeconds)">
                                @if (timeRemaining.TotalSeconds <= 0)
                                {
                                    <span class="ended-text" aria-label="Auction ended">Auction ended</span>
                                }
                                else
                                {
                                    <div class="countdown-box">
                                        <span class="clock-icon" aria-hidden="true">
                                            <!-- SVG or Font Awesome icon -->
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="alarm-icon" viewBox="0 0 16 16">
                                                <path d="M8 3a5 5 0 1 0 0 10A5 5 0 0 0 8 3zM8 0a.5.5 0 0 1 .5.5V1a.5.5 0 0 1-1 0v-.5A.5.5 0 0 1 8 0zm5.657 2.343a.5.5 0 0 1 .707 0l.354.353a.5.5 0 0 1-.707.708l-.354-.354a.5.5 0 0 1 0-.707zM16 8a.5.5 0 0 1-.5.5h-.5a.5.5 0 0 1 0-1h.5A.5.5 0 0 1 16 8zM13.657 13.657a.5.5 0 0 1-.707 0l-.354-.353a.5.5 0 0 1 .707-.708l.354.354a.5.5 0 0 1 0 .707zM8 15a.5.5 0 0 1-.5-.5V14a.5.5 0 0 1 1 0v.5a.5.5 0 0 1-.5.5zm-5.657-1.343a.5.5 0 0 1-.707 0l-.354-.354a.5.5 0 0 1 .707-.707l.354.354a.5.5 0 0 1 0 .707zM1 8a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 0 1H1.5A.5.5 0 0 1 1 8zm1.343-5.657a.5.5 0 0 1 .707 0l.354.354a.5.5 0 0 1-.707.707l-.354-.353a.5.5 0 0 1 0-.708z" />
                                                <path d="M8 4.5a.5.5 0 0 1 .5.5v3.25l2.25 1.35a.5.5 0 1 1-.5.866l-2.5-1.5A.5.5 0 0 1 7.5 8V5a.5.5 0 0 1 .5-.5z" />
                                            </svg>
                                        </span>
                                        <span class="countdown">    @(timeRemaining.Days) days @(timeRemaining.Hours) hours @(timeRemaining.Minutes) minutes @(timeRemaining.Seconds) seconds</span>
                                    </div>
                                }
                            </div>


                        </div>

                        <div class="recent-bids">
                            <h4>Recent Bids</h4>
                            <ul>
                                @{
                                    bool hasBids = false;
                                    foreach (var bid in item.RecentBids ?? new List<Kisvarda.Dnn.Dnn.Kisvarda.Aukcio.Models.Bid>())
                                    {
                                        hasBids = true;
                                        <li>User ID: @bid.UserId - $@bid.Amount</li>
                                    }
                                }

                                @if (!hasBids)
                                {
                                    <li>No bids yet.</li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const countdownElements = document.querySelectorAll(".time-remaining");

        countdownElements.forEach(function (element) {
            const totalSeconds = parseInt(element.getAttribute("data-time-remaining"), 10);
            const countdownSpan = element.querySelector(".countdown");

            if (totalSeconds > 0) {
                let remainingSeconds = totalSeconds;

                const interval = setInterval(function () {
                    if (remainingSeconds <= 0) {
                        clearInterval(interval);
                        countdownSpan.textContent = "Auction ended";
                        element.classList.add("ended-text");
                    } else {
                        const days = Math.floor(remainingSeconds / 86400);
                        const hours = Math.floor((remainingSeconds % 86400) / 3600);
                        const minutes = Math.floor((remainingSeconds % 3600) / 60);
                        const seconds = remainingSeconds % 60;

                        countdownSpan.textContent = `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        remainingSeconds--;
                    }
                }, 1000);
            } else {
                countdownSpan.textContent = "Auction ended";
                element.classList.add("ended-text");
            }
        });
    });

</script>

